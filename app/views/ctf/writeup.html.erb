<%= render_taskbar_items([
  { image_path: 'task-bar/flag.svg', alt_text: "CTF Icon", label: "CTF", link: ctf_path },
]) %>
<%= render_terminal([], true) %>

<div class="writeup-wrapper gap-4 mx-4">
  <div class="writeup-container bg-primary">
    <h4 class="writeup-year text-white text-center"><%= @which.upcase %>-<%= @ctf_info["year"] %></h4>
    <h1 class="writeup-title text-white"><%= @ctf_info["title"] %></h1>
    <%# build relative path (no leading slash) %>
    <% file_rel = "#{@which}/#{@ctf_info['year']}/#{@ctf_info['challengefiles']}".to_s %>
    <% basename = File.basename(@ctf_info['challengefiles'].to_s) %>
    <% file_abs_path = Rails.root.join("public", "ctf", "files", file_rel) %>
    <% file_exists = @ctf_info["challengefiles"].present? && File.exist?(file_abs_path) %>

    <div class="writeup-challengefiles flex flex-col items-center gap-3">
      <div class="flex items-center gap-4">
        <% if @ctf_info["challengefiles"].blank? %>
          <span class="inline-flex items-center gap-2 rounded-full bg-yellow-600/10 px-3 py-1 text-sm font-medium text-gray-300 shadow-sm">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M14 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M14 3v5h5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            No files for the challenge
          </span>

        <% elsif !file_exists %>
          <!-- File specified but missing on disk -->
          <span class="inline-flex items-center gap-2 rounded-full bg-red-600/10 px-3 py-1 text-sm font-medium text-red-300 shadow-sm">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            File not found
          </span>

          <small class="text-xs text-red-200/70 ml-2">Contact an admin or check the file path.</small>

        <% else %>
          <span class="inline-flex items-center gap-2 rounded-full bg-white/6 px-3 py-1 text-sm font-medium text-white/90 shadow-sm">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M14 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M14 3v5h5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="truncate max-w-[28ch]"><%= basename %></span>
          </span>

          <% size = number_to_human_size(File.size(file_abs_path)) rescue nil %>
          <%= link_to ctf_file_download_path(file_rel),
                      class: "inline-flex items-center gap-2 px-4 py-2 rounded-2xl text-white font-semibold transform transition hover:-translate-y-0.5 hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-300",
                      target: "_blank",
                      rel: "noopener",
                      aria: { label: "Download #{basename}" },
                      style: "background: linear-gradient(90deg,#6366f1 0%,#06b6d4 100%); box-shadow: 0 24px 50px rgba(99,102,241,0.22), 0 8px 24px rgba(6,182,212,0.10);" do %>
            <!-- download icon -->
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3v12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 11l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M21 21H3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Download <%= size %>
          <% end %>
        <% end %>
      </div>
    </div>


    <%= @html_content %>
  </div>

  <div class="table-of-content bg-primary">
    <h3 class="text-slate-100 font-semibold text-3xl"><%= @ctf_info["title"] %> - Table of contents</h3>
    <ul class="text-slate-100">
      <% @headings.each do |heading| %>
        <% indent_level = heading[:text].count(".") - 1 %>
        <li class="ml-<%= indent_level * 6 %>">
          <a href="#<%= heading[:anchor] %>" class="toc-anchor group flex items-start py-1">
            <% if indent_level > 0 %>
              <svg width="3" height="24" viewBox="0 -9 3 24"
                class="mr-2 text-slate-400 overflow-visible group-hover:text-slate-600 dark:text-slate-600 dark:group-hover:text-slate-500">
                <path d="M0 0L3 3L0 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                </path>
              </svg>
            <% end %>
            <%= heading[:text] %>
          </a>
        </li>
      <% end %>
    </ul>
  </div>
</div>
