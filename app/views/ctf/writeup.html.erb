<%= render_taskbar_items([
  { image_path: 'task-bar/flag.svg', alt_text: "CTF Icon", label: "CTF", link: ctf_path },
]) %>
<%= render_terminal([], true) %>

<div class="writeup-wrapper gap-4 mx-4">
  <div class="writeup-container bg-primary">
    <h4 class="writeup-year text-white text-center"><%= @which.upcase %>-<%= @ctf_info["year"] %></h4>
    <h1 class="writeup-title text-white"><%= @ctf_info["title"] %></h1>

    <% basename = File.basename("#{@ctf_info['challengefiles']}.zip")  %>

    <% file_rel = "#{@which}/#{@ctf_info['year']}/#{@ctf_info['challengefiles']}.zip".to_s %>
    <% file_abs_path = Rails.root.join("public", "ctf", "files", file_rel) %>
    <% file_exists = "#{@ctf_info['challengefiles']}.zip".present? && File.exist?(file_abs_path) %>

    <% pdf_rel = "#{@which}/#{@ctf_info['year']}/#{@ctf_info['challengefiles']}.pdf".to_s %>
    <% pdf_abs_path = Rails.root.join("public", "ctf", "writeups", pdf_rel) %>
    <% pdf_exists = "#{@ctf_info['challengefiles']}.pdf".present? && File.exist?(pdf_abs_path) %>

    <div class="writeup-challengefiles flex flex-col items-center gap-3">
      <div class="flex items-center gap-4">

        <% if file_exists %>
          <% size = number_to_human_size(File.size(file_abs_path)) rescue nil %>
          <%= link_to ctf_file_download_path(file_rel),
                      class: "download-btn bg-tertiary inline-flex items-center gap-2 px-4 py-2 rounded-2xl text-black font-semibold mt-3",
                      target: "_blank",
                      rel: "noopener",
                      aria: { label: "Download #{basename}" },
                      style: "background: box-shadow: 0 8px 24px rgba(99,102,241,0.22);" do %>
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3v12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 11l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M21 21H3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <%= basename %> - <%= size %>
          <% end %>
        <% end %>

        <% if pdf_exists %>
          <%= link_to "/ctf/writeups/#{pdf_rel}",
                      class: "open-pdf-btn bg-tertiary inline-flex items-center gap-2 px-4 py-2 rounded-2xl text-black font-semibold mt-3",
                      target: "_blank",
                      rel: "noopener",
                      aria: { label: "PDF Writeup" },
                      style: "background: box-shadow: 0 8px 24px rgba(59,130,246,0.22);" do %>
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 19a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h7l5 5v9a2 2 0 0 1-2 2H6z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M13 7V2.5L18.5 8H14a1 1 0 0 1-1-1z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            PDF Writeup
          <% end %>
        <% end %>

      </div>
    </div>

    <%= @html_content %>
  </div>

  <div class="table-of-content bg-primary">
    <h3 class="text-slate-100 font-semibold text-3xl">Table of contents</h3>
    <ul class="text-slate-100">
      <% @headings.each do |heading| %>
        <% indent_level = heading[:text].count(".") - 1 %>
        <li class="ml-<%= indent_level * 6 %>">
          <a href="#<%= heading[:anchor] %>" class="toc-anchor group flex items-start py-1">
            <% if indent_level > 0 %>
              <svg width="3" height="24" viewBox="0 -9 3 24"
                class="mr-2 text-slate-400 overflow-visible group-hover:text-slate-600 dark:text-slate-600 dark:group-hover:text-slate-500">
                <path d="M0 0L3 3L0 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                </path>
              </svg>
            <% end %>
            <%= heading[:text] %>
          </a>
        </li>
      <% end %>
    </ul>
  </div>
</div>
